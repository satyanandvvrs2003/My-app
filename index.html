<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Seamless Looper with Immediate Play</title>
<style>
  body {
    background:#e0e5ec;
    font-family:sans-serif;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:20px;
    min-height:100vh;
  }
  .container {
    width: 100%;
    max-width: 420px;
    padding:20px;
    background:#e0e5ec;
    border-radius:25px;
    box-shadow:8px 8px 20px #babecc, -8px -8px 20px #fff;
    display:flex;
    flex-direction:column;
    align-items:center;
  }
  h2 {
    margin-bottom:20px;
    font-size:1.5em;
    text-align: center;
    color:#333;
  }
  button {
    margin:10px 5px;
    padding:14px 15px;
    border:none;
    border-radius:20px;
    box-shadow:4px 4px 12px #babecc, -4px -4px 12px #fff;
    font-size:1em;
    cursor:pointer;
    background:#e0e5ec;
    transition:all 0.2s;
    flex-shrink: 0;
  }
  button:active {
    box-shadow: inset 4px 4px 12px #babecc, inset -4px -4px 12px #fff;
  }
  #tracks {
    width:100%;
    margin-top:20px;
    display:flex;
    flex-direction:column;
    gap:15px;
  }
  .track {
    display:flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    background:#f1f2f6;
    border-radius:20px;
    padding:15px;
    box-shadow:4px 4px 12px #babecc, -4px -4px 12px #fff;
  }
  .track > span {
    width: 100%;
    font-weight: 600;
    margin-bottom: 8px;
    color:#444;
  }
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
    justify-content: center;
  }
  .timer {
    font-family: monospace;
    font-size: 14px;
    color: #555;
    margin: 0 10px;
    min-width: 60px;
    text-align: center;
  }
  @media(max-width: 480px){
    .container { padding: 15px; }
    button { padding: 10px; font-size: 14px; }
  }
</style>
</head>
<body>
<div class="container">
<h2>ğŸ§ Seamless Multi-Track Looper</h2>
<div id="tracks"></div>
<button id="addTrack">+ Add Track</button>
<button id="exportAudio">ğŸ’¾ Export All Tracks</button>
<p><em>Immediate recording & loopingâ€”seamless experience!</em></p>
</div>
<script>
(async() => {
  let trackCount=0;
  let mediaRecorders=[], mediaStreams=[], audioBlobs=[], loopAudios=[], audioURLs=[], isRecording=[], timers=[], timerInts=[];
  const STORAGE_KEY='multiTrackLooperData';
  const audioContext=new (window.AudioContext||window.webkitAudioContext)();

  async function resumeAudio() {
    if(audioContext.state==='suspended') await audioContext.resume();
  }

  function formatTime(sec){ const m=Math.floor(sec/60).toString().padStart(2,'0'); const s=(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }
  function startTimer(i){ let sec=0; timers[i].textContent= formatTime(sec); timerInts[i]=setInterval(()=>{ sec++; timers[i].textContent= formatTime(sec); },1000); }
  function resetTimer(i){ clearInterval(timerInts[i]); timers[i].textContent='00:00'; }

  function clearURL(i){ if(audioURLs[i]){ URL.revokeObjectURL(audioURLs[i]); audioURLs[i]=null; } }

  async function saveAll(){ 
    const base64s= await Promise.all(audioBlobs.map(blob=>blob?blobToBase64(blob):null));
    localStorage.setItem(STORAGE_KEY,JSON.stringify(base64s));
  }
  async function loadAll(){
    const data=localStorage.getItem(STORAGE_KEY);
    if(!data) return;
    const arr=JSON.parse(data);
    for(let i=0;i<arr.length;i++){
      if(arr[i]){
        audioBlobs[i]= await base64ToBlob(arr[i]);
        createTrack(i,true);
      }
    }
  }

  function createTrack(index=null,hydrate=false){
    if(index==null) { index=trackCount++; } 
    else if(index>=trackCount){ trackCount=index+1; }

    const container=document.getElementById('tracks');
    const track=document.createElement('div');
    track.className='track'; track.id=`track-${index}`;
    track.innerHTML=`
      <span>Track ${index+1}</span>
      <div class="timer" id="timer${index}">00:00</div>
      <div class="controls">
        <button id="record${index}">ğŸ™ï¸ Record</button>
        <button id="play${index}">ğŸ”„ Play Loop</button>
        <button id="stop${index}">â¹ï¸ Stop</button>
        <button id="delRec${index}">ğŸ—‘ï¸ Delete Rec</button>
        <button id="delTrack${index}">âŒ Delete Track</button>
      </div>
    `;
    container.appendChild(track);
    isRecording[index]=false; timers[index]=document.getElementById(`timer${index}`);

    // Record
    document.getElementById(`record${index}`).onclick=async()=>{
      await resumeAudio();
      if(isRecording[index]){
        mediaRecorders[index].stop();
        mediaStreams[index].getTracks().forEach(t=>t.stop());
        resetTimer(index);
        isRecording[index]=false; document.getElementById(`record${index}`).textContent='ğŸ™ï¸ Record';
      } else {
        try{
          const stream=await navigator.mediaDevices.getUserMedia({audio:true});
          mediaStreams[index]=stream;
          const rec=new MediaRecorder(stream);
          mediaRecorders[index]=rec; let chunks=[];
          rec.ondataavailable=e=>chunks.push(e.data);
          rec.onstop=async()=>{
            audioBlobs[index]=new Blob(chunks,{type:'audio/webm'});
            chunks=[];
            clearURL(index); // remove old URL for latency
            audioURLs[index]=URL.createObjectURL(audioBlobs[index]);
            await saveAll();
          };
          rec.start(); isRecording[index]=true; startTimer(index);
          document.getElementById(`record${index}`).textContent='â¹ï¸ Stop';
        } catch(e){ alert('Mic permission chahiye!'); console.error(e); }
      }
    };

    // Play Loop
    document.getElementById(`play${index}`).onclick=()=>{
      if(!audioBlobs[index]){ alert('Pehle record karo!'); return; }
      if(audioURLs[index]==null){ 
        clearURL(index);
        audioURLs[index]=URL.createObjectURL(audioBlobs[index]);
      }
      if(loopAudios[index] && !loopAudios[index].paused){ // pause
        loopAudios[index].pause();
        document.getElementById(`play${index}`).textContent='ğŸ”„ Play Loop';
        return;
      }
      const a=new Audio(audioURLs[index]);
      a.loop=true; a.play();
      loopAudios[index]=a;
      document.getElementById(`play${index}`).textContent='â¹ï¸ Pause Loop';
    };

    // Stop (Recording/Playing)
    document.getElementById(`stop${index}`).onclick=()=>{
      if(isRecording[index]){
        mediaRecorders[index].stop();
        mediaStreams[index].getTracks().forEach(t=>t.stop());
        resetTimer(index);
        isRecording[index]=false;
        document.getElementById(`record${index}`).textContent='ğŸ™ï¸ Record';
      }
      if(loopAudios[index] && !loopAudios[index].paused){
        loopAudios[index].pause();
        document.getElementById(`play${index}`).textContent='ğŸ”„ Play Loop';
      }
    };

    // Delete Recording
    document.getElementById(`delRec${index}`).onclick=()=>{
      if(isRecording[index]){
        alert('Recording chal rahi hai, pehle stop karo!');
        return;
      }
      if(loopAudios[index] && !loopAudios[index].paused) { loopAudios[index].pause(); }
      audioBlobs[index]=null;
      clearURL(index);
      saveAll();
      alert(`Track ${index+1} ke recording delete.`);
    }

    // Delete Track
    document.getElementById(`delTrack${index}`).onclick=()=>{
      if(isRecording[index]){
        alert('Recording chal rahi hai! Pehle stop karo.');
        return;
      }
      if(loopAudios[index] && !loopAudios[index].paused){ loopAudios[index].pause(); }
      // remove UI
      document.getElementById(`track-${index}`).remove();
      // clear data
      audioBlobs[index]=null; clearURL(index);
      if(timerInts[index]){ clearInterval(timerInts[index]); }
      saveAll();
    }
  }

  document.getElementById('addTrack').onclick=()=>createTrack();
  document.getElementById('exportAudio').onclick=()=>{
    if(audioBlobs.every(b=>!b)){ alert('Koi recording nahi!'); return; }
    audioBlobs.forEach((b,i)=>{
      if(b){
        const url=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=url; a.download=`Track_${i+1}.webm`; a.click();
      }
    });
  }

  await loadAll(); // load previously saved
  if(document.getElementById('tracks').children.length===0) createTrack();
})();
</script>
</div>
</body>
</html>
